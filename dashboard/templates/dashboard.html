{% extends "base.html" %}
{% block content %}
<style>
    #kcal_intake_for_day_canvas {
        width:150px !important;
        height:150px !important;
    }
</style>
<div class="container">
    <canvas id="water_intake_for_week" width="400" height="400"></canvas>
</div>
<div class="container">
    <canvas id="kcal_intake_for_day_canvas" width="100" height="100"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {




    // 一週間の水分摂取量
    fetch("/records/api/weekly/")
        .then(response => response.json())
        .then(data => {
            let originalDates = data.summary.map(entry => entry.date).reverse(); // `YYYY-MM-DD`
            let labels = originalDates.map(date => date.slice(5));  // `MM-DD` 表示用
            let quantities = data.summary.map(entry => entry.total_quantity).reverse();  // 逆順
            const details = data.details;
            let selectedDate = originalDates[6];  // 最新日

            const ctx = document.getElementById("water_intake_for_week").getContext("2d");
            //グラフの描画
            const chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "摂取水分量(ml)",
                        data: quantities,
                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { display: false },  // 縦軸のメモリを非表示
                        x: { ticks: { color: "black" } }  // 横軸の文字色を明示
                    },
                    onClick: function(event) {
                        const elements = chart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, false);
                        if (elements.length > 0) {
                            const index = elements[0].index;
                    
                            if (index !== undefined && originalDates[index]) {
                                selectedDate = originalDates[index];
                                updateDetailTable(selectedDate);
                                //console.log("詳細テーブルを更新しました");
                            } else {
                                //console.log("選択されたインデックスが無効または日付が取得できない");
                            }
                        } else {
                            //console.log("クリックしたけど要素が取得できなかった");
                        }
                    }                    
                    
                }
            });

            updateDetailTable(selectedDate);

            //詳細情報の更新
            function updateDetailTable(date) {
                const tableBody = document.querySelector("#detailTable tbody");
                const detailTable = document.getElementById("detailTable");
                const noDataMessage = document.getElementById("noDataMessage");

                tableBody.innerHTML = "";

                if (details[date] && details[date].length > 0) {
                    details[date].forEach(entry => {
                        const row = `<tr>
                            <td>${entry.drink_name}</td>
                            <td>${entry.quantity}</td>
                            <td>${entry.caffeine}</td>
                            <td>${entry.sugars}</td>
                            <td>${entry.salt}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                    detailTable.style.display = "table";  // データがある場合はテーブルを表示
                    noDataMessage.style.display = "none";  // 「データがありません」を非表示
                } else {
                    detailTable.style.display = "none";  // テーブルを非表示
                    noDataMessage.style.display = "block"; // 「データがありません」を表示
                }

                document.getElementById("detailTitle").innerText = `詳細情報 (${date})`;
            }
        });

    // 一日の摂取カロリー
    const kcalIntakeForDayCanvas = document.getElementById('kcal_intake_for_day_canvas');
    // 真ん中に表示するオブジェクト
    const kcalIntakeForDayCenterText = {
        id: 'counter',
        beforeDraw(chart, args, options) {
            const { ctx, chartArea: { top, right , bottom, left, width, height } } = chart;
            ctx.save();
            ctx.fillStyle = 'black';
            // ctx.fillRect(width / 2, top + (height / 2), 0, 0);
            ctx.font = '9px sans-serif';
            ctx.textAlign = 'center';
            
            // 位置調整
            console.log("width", width);
            console.log("height", height);
            console.log("top", top);
            console.log("width / 2, top + (height / 2)", width / 2, top + (height / 2));
            fillTextLine(ctx,'2300\n/2800kcal', width / 2, top + (height / 2));
        }
        };

        const kcal_intake_for_day = 2300;
        const goal_for_day = 2800;
        const kcalIntakeForDayChart = new Chart(kcalIntakeForDayCanvas, {
        type: 'doughnut',
        data: {
            labels: ['', ''],
            datasets: [{
            label: 'votes',
            data: [kcal_intake_for_day, goal_for_day-kcal_intake_for_day],
            backgroundColor: [
                "rgba(54, 162, 235, 0.5)",
                'rgba(201, 203, 207, 0.2)',
            ],
            borderColor: [
                "rgba(54, 162, 235, 1)",
                'rgb(201, 203, 207)',
            ],
            }]                       
        },
        options: {
            responsive: true,
            plugins: {
            legend: {
                display: false,
                position: 'left',
            },
            title: {
                display: true,
                text: '一日の摂取カロリー',
                position: 'top',
                align: 'center',
            },
            counter: {
                fontColor: 'red',
                fontSize: '50px',
                fontFamily: 'sans-serif',
            },
            },
        },
        plugins: [kcalIntakeForDayCenterText]
    });
});
//改行させるためのファンクション
function fillTextLine (context, text, x, y) {
    var textList = text.split('\n');//\nで分割して配列にします。
    var lineHeight = context.measureText("あ").width;// あ　はフォントのサイズを取得するのに利用しているだけです。
    textList.forEach(function(text, i) {//配列を順番に読み出して、y（高さ）を計算しながら描画していきます。
        context.fillText(text, x, y+lineHeight*i);
    });
};
</script>
{% endblock %}
